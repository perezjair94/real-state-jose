<VirtualHost *:80>
    ServerName localhost
    ServerAlias *.local

    DocumentRoot /var/www/html

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted

        # mod_rewrite configuration
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /

            # Allow access to assets/uploads - images must be accessible
            RewriteRule ^assets/uploads/ - [L]

            # Prevent direct access to config and includes
            RewriteRule ^(config|includes|database)/ - [F,L]

            # Redirect index.php requests
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php/$1 [L]
        </IfModule>
    </Directory>

    # Allow direct access to uploaded files
    <Directory /var/www/html/assets/uploads>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
        <IfModule mod_rewrite.c>
            RewriteEngine Off
        </IfModule>
    </Directory>

    # Prevent access to sensitive files
    <FilesMatch "^(\.env|\.git|\.htaccess|composer\.json|README|CLAUDE\.md|INSTRUCCIONES)">
        Deny from all
    </FilesMatch>

    # Enable GZIP compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Set proper headers
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
    </IfModule>

    # Error and Access logs
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
